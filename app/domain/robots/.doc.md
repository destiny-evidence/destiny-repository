# robots (.doc.md)

## Purpose

- Manage robot registrations (external services that process enhancements)
- Handle robot authentication via client secrets
- Does **not** handle enhancement batch processing (see `../references/services/enhancement_service.py`)

## Responsibilities

- Robot registration and metadata management
- Client secret generation and cycling
- Robot authentication for API requests

## Key Entry Points

- `service.py` - Main service for robot CRUD and secret management
- `routes.py` - FastAPI route handlers for robot API
- `repository.py` - SQL repository for robot records

## Important Invariants / Constraints

- `client_secret` is stored as `SecretStr` to prevent accidental logging
- Secrets are generated as 32 bytes hex on creation
- Secret cycling invalidates the old secret immediately

## Public Surface Area

### API Endpoints (see `routes.py`)

- `POST /robots` - Register new robot (returns secret once)
- `GET /robots` - List robots
- `GET /robots/{id}` - Get robot details
- `PATCH /robots/{id}` - Update robot metadata
- `POST /robots/{id}/cycle-secret` - Rotate client secret

### Used By

- Enhancement batch API uses robot authentication
- SDK `RobotClient` uses robot credentials for polling/submitting work

## Typical Workflows

### Registering a new robot

1. Call `POST /robots` with name, description, owner
2. Save the returned `client_secret` (only shown once)
3. Use secret in robot client for authentication

### Cycling a compromised secret

1. Call `POST /robots/{id}/cycle-secret`
2. Update robot client with new secret
3. Old secret is immediately invalid

## Testing

```bash
# Run robot domain tests
uv run pytest tests/unit/domain/robots/
```

## Debugging Notes

- Robot can't authenticate? Check if secret was cycled
- Secret not returned? It's only shown once at registration

## Related Docs

- `docs/claude/robots.md` - Robot internals
- `../references/services/enhancement_service.py` - Batch processing logic
- `docs/procedures/robot-automation.rst` - Robot usage guide
- `docs/procedures/robot-registration.rst` - Registration guide
- `libs/sdk/src/destiny_sdk/robot_client.py` - SDK robot client
- `docs/repo-map.md` - Repository overview

## Folder Structure

```text
robots/
├── models/
│   ├── models.py  # Domain model (Robot)
│   └── sql.py     # SQLAlchemy ORM model
├── services/
│   └── (anti_corruption_service.py if exists)
├── repository.py  # Repository pattern implementation
├── routes.py      # FastAPI routes
└── service.py     # Main domain service
```
