# persistence (.doc.md)

## Purpose

- Provide data access abstractions for all storage backends
- Manage transactions and unit of work patterns
- Does **not** contain business logic (belongs in domain services)

## Responsibilities

- SQL (PostgreSQL) session and transaction management
- Elasticsearch client and index management
- Blob storage (MinIO locally, Azure Blob in production)
- Base repository patterns and generics
- Unit of work decorators for transaction boundaries

## Key Entry Points

- `uow.py` - Unit of work decorators (`@sql_unit_of_work`, `@es_unit_of_work`)
- `repository.py` - Base repository protocol/interface
- `sql/session.py` - SQLAlchemy async session factory
- `es/client.py` - Elasticsearch client setup
- `blob/client.py` - Blob storage client abstraction

## Important Invariants / Constraints

- PostgreSQL is the source of truth; Elasticsearch is derived
- Every persistence operation must be inside exactly one unit of work
- Unit of work decorators handle commit/rollback automatically
- ES can be rebuilt from SQL at any time

## Public Surface Area

### Unit of Work Decorators

```python
from app.persistence.uow import sql_unit_of_work, es_unit_of_work

class MyService:
    @sql_unit_of_work
    async def my_sql_operation(self):
        # Transaction committed on success, rolled back on exception
        pass

    @es_unit_of_work
    async def my_es_operation(self):
        # ES operations batched and committed
        pass
```

### Repository Pattern

Domain repositories inherit from base classes in each subfolder:

- `sql/repository.py` - SQL repository base
- `es/repository.py` - ES repository base
- `blob/repository.py` - Blob repository base

## Typical Workflows

### Adding a new SQL repository method

1. Add method to domain's `repository.py`
2. Ensure calling service method uses `@sql_unit_of_work`
3. Use `self.session` for SQLAlchemy operations

### Rebuilding Elasticsearch index

1. Use `es/index_manager.py` utilities
2. Reindex from SQL source of truth
3. No data loss since ES is derived

## Testing

```bash
# Run persistence unit tests
uv run pytest tests/unit/persistence/

# Run integration tests (real DB)
uv run pytest tests/integration/
```

Unit tests use `FakeRepository` from `tests/unit/domain/conftest.py`.

## Debugging Notes

- Transaction not committing? Check if `@sql_unit_of_work` decorator is applied
- ES out of sync? Rebuild index from SQL
- Blob upload failing? Check MinIO container is running (local) or Azure credentials (prod)

## Related Docs

- `docs/codebase/persistence/` - Persistence layer documentation
- `../domain/references/.doc.md` - Main consumer of persistence
- `docs/repo-map.md` - Repository overview

## Folder Structure

```text
persistence/
├── sql/
│   ├── session.py     # Async session factory
│   ├── repository.py  # SQL repository base class
│   ├── uow.py         # SQL unit of work
│   └── persistence.py # SQL persistence config
├── es/
│   ├── client.py       # ES client setup
│   ├── repository.py   # ES repository base class
│   ├── index_manager.py # Index creation/management
│   ├── uow.py          # ES unit of work
│   └── persistence.py  # ES persistence config
├── blob/
│   ├── client.py      # Blob client abstraction
│   ├── clients/       # Provider implementations (MinIO, Azure)
│   ├── repository.py  # Blob repository base
│   └── models.py      # Blob-related models
├── repository.py   # Base repository protocol
├── uow.py          # Unit of work decorators
├── generics.py     # Generic type helpers
└── persistence.py  # Shared persistence utilities
```
