# tests (.doc.md)

## Purpose

- Provide comprehensive test coverage for the DESTINY Repository
- Organize tests by type: unit, integration, e2e, router
- Provide reusable fixtures and factories for test data

## Responsibilities

- Test fixtures and configuration (`conftest.py`)
- Factory definitions for test data (`factories.py`)
- Database and Elasticsearch test utilities
- Fake repository implementations for unit testing

## Key Entry Points

- `conftest.py` - Main fixtures (database, ES, auth mocks, test client)
- `factories.py` - `factory_boy` factories for all domain models
- `unit/domain/conftest.py` - `FakeRepository` and `FakeUnitOfWork` for unit tests
- `db_utils.py` - Database test utilities
- `es_utils.py` - Elasticsearch test utilities

## Important Invariants / Constraints

- E2E tests require Docker (testcontainers)
- E2E tests are excluded by default; run with `pytest tests/e2e`
- Unit tests should use `FakeRepository`, not real database
- Factories use `Faker` for realistic test data

## Running Tests

```bash
# Run all tests (excludes e2e by default)
uv run pytest

# Run specific test file
uv run pytest tests/unit/domain/references/services/test_deduplication_service.py

# Run specific test function
uv run pytest tests/unit/domain/references/services/test_deduplication_service.py::test_function_name

# Run e2e tests (requires Docker)
uv run pytest tests/e2e --log-cli-level info

# Run with coverage
uv run pytest --cov=app

# Run tests matching a pattern
uv run pytest -k "deduplication"
```

## Key Factories

| Factory                                   | Model                              | Notes                                            |
| ----------------------------------------- | ---------------------------------- | ------------------------------------------------ |
| `ReferenceFactory`                        | `Reference`                        | Creates reference with identifiers, enhancements |
| `RobotFactory`                            | `Robot`                            | Creates robot with credentials                   |
| `PendingEnhancementFactory`               | `PendingEnhancement`               | For testing enhancement processing               |
| `DOIIdentifierFactory`                    | `DOIIdentifier`                    | Uses Faker's doi provider                        |
| `OpenAlexIdentifierFactory`               | `OpenAlexIdentifier`               | Generates W-prefixed IDs                         |
| `BibliographicMetadataEnhancementFactory` | `BibliographicMetadataEnhancement` | Title, authors, year, etc.                       |

## Using Factories

```python
from tests.factories import ReferenceFactory, DOIIdentifierFactory

# Create with defaults
reference = ReferenceFactory()

# Create with specific values
reference = ReferenceFactory(
    identifiers=[
        LinkedExternalIdentifier(identifier=DOIIdentifierFactory())
    ]
)
```

## Using FakeRepository

```python
from tests.unit.domain.conftest import FakeRepository, FakeUnitOfWork

# In test fixtures
@pytest.fixture
def fake_repo():
    return FakeRepository(init_entries=[existing_reference])

@pytest.fixture
def fake_sql_uow(fake_repo):
    return FakeUnitOfWork(references=fake_repo)
```

## Test Organization

| Folder         | Purpose                       | Dependencies            |
| -------------- | ----------------------------- | ----------------------- |
| `unit/`        | Isolated business logic tests | FakeRepository only     |
| `integration/` | Tests with real database      | PostgreSQL              |
| `e2e/`         | Full stack tests              | Docker (testcontainers) |
| `routers/`     | API endpoint tests            | Test client             |
| `core/`        | Core module tests             | Varies                  |

## Debugging Notes

- Test hanging? Check for unawaited coroutines
- Factory not generating expected data? Check `Faker` providers
- E2E tests failing? Ensure Docker is running
- Fixture not found? Check `conftest.py` scope

## Related Docs

- `docs/claude/testing.md` - Detailed testing guide
- `app/domain/*/` - Domain code being tested
- `docs/repo-map.md` - Repository overview

## Folder Structure

```text
tests/
├── conftest.py      # Main fixtures
├── factories.py     # factory_boy factories
├── db_utils.py      # Database utilities
├── es_utils.py      # Elasticsearch utilities
├── unit/
│   ├── domain/
│   │   ├── conftest.py  # FakeRepository, FakeUnitOfWork
│   │   ├── references/  # Reference domain tests
│   │   └── imports/     # Import domain tests
│   └── persistence/     # Persistence layer tests
├── integration/         # Real database tests
├── e2e/                 # End-to-end tests
│   ├── enhancements/
│   └── imports/
├── routers/             # API router tests
└── core/                # Core module tests
```
