# references (.doc.md)

## Purpose

- Core domain for managing scholarly references (papers, articles, etc.)
- Handles the full reference lifecycle: creation, enhancement, deduplication, search, and indexing
- Does **not** handle import orchestration (see `../imports/.doc.md`)

## Responsibilities

- Reference CRUD operations
- Deduplication detection and resolution
- Enhancement storage and projection
- Elasticsearch indexing and search
- Identifier management (DOI, OpenAlex, etc.)
- Pending enhancement tracking for robot processing

## Key Entry Points

- `service.py` - Main service with reference CRUD, the primary entry point for most operations
- `routes.py` - FastAPI route handlers, defines the REST API surface
- `repository.py` - SQL and Elasticsearch repository implementations
- `services/deduplication_service.py` - Duplicate detection and canonical resolution
- `services/enhancement_service.py` - Enhancement batch processing for robots

## Important Invariants / Constraints

- Only one `ReferenceDuplicateDecision` per reference can have `active_decision=True` (enforced by partial unique index)
- Duplicate chains have a max depth (`MAX_REFERENCE_DUPLICATE_DEPTH` in `app/core/constants.py`)
- PostgreSQL is source of truth; Elasticsearch is derived and can be rebuilt
- All service methods with persistence must be wrapped in `@sql_unit_of_work` or `@es_unit_of_work`

## Public Surface Area

### API Endpoints (see `routes.py`)

- `GET /references` - List/search references
- `GET /references/{id}` - Get single reference
- `POST /references` - Create reference
- `PATCH /references/{id}` - Update reference
- `DELETE /references/{id}` - Delete reference
- `POST /references/{id}/enhancements` - Add enhancement
- `POST /references/search` - Advanced search

### Background Tasks (see `tasks.py`)

- `index_reference_task` - Index reference to Elasticsearch
- `deduplicate_reference_task` - Run deduplication on a reference

## Typical Workflows

### Adding a reference programmatically

1. Call `ReferenceService.create_reference()` with reference data
2. Service creates reference, runs deduplication, queues indexing task

### Debugging deduplication issues

1. Check `ReferenceDuplicateDecision` records for the reference
2. Look at `determination` field for current state
3. If DECOUPLED, multiple potential canonicals were found - requires manual review

## Testing

```bash
# Run reference domain unit tests
uv run pytest tests/unit/domain/references/

# Run specific deduplication tests
uv run pytest tests/unit/domain/references/services/test_deduplication_service.py
```

Uses `FakeRepository` and `FakeUnitOfWork` from `tests/unit/domain/conftest.py`.

## Debugging Notes

- Deduplication stuck? Check `DuplicateDetermination` state in database
- Search not returning results? Check if reference is indexed (`is_indexed` field)
- Enhancement projection wrong? Check enhancement priority ordering in `projections.py`

## Related Docs

- `docs/claude/deduplication.md` - Detailed deduplication internals
- `docs/claude/enhancements.md` - Enhancement system details
- `../imports/.doc.md` - Import orchestration
- `../robots/.doc.md` - Robot batch processing
- `docs/repo-map.md` - Repository overview

## Folder Structure

```text
references/
├── models/
│   ├── models.py      # Domain models (Reference, Enhancement, etc.)
│   ├── sql.py         # SQLAlchemy ORM models
│   ├── es.py          # Elasticsearch document models
│   ├── projections.py # Computed/derived models for search
│   └── validators.py  # Pydantic validators
├── services/
│   ├── anti_corruption_service.py  # SDK <-> domain translation
│   ├── deduplication_service.py    # Duplicate detection/resolution
│   ├── enhancement_service.py      # Robot enhancement batches
│   ├── search_service.py           # Search query building
│   └── synchronizer_service.py     # SQL/ES sync utilities
├── repository.py  # Repository pattern implementations
├── routes.py      # FastAPI routes
├── service.py     # Main domain service
└── tasks.py       # Background tasks
```
