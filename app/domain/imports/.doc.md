# imports (.doc.md)

## Purpose

- Orchestrate batch importing of references from external sources
- Track import progress, status, and results
- Does **not** handle individual reference creation (delegates to `../references/`)

## Responsibilities

- Import record management (jobs)
- Import batch chunking and processing
- Import result tracking per reference
- Status transitions and error handling
- Deadlock retry logic for concurrent imports

## Key Entry Points

- `service.py` - Main service for import orchestration
- `routes.py` - FastAPI route handlers for import API
- `repository.py` - SQL repository for import records/batches/results
- `tasks.py` - Background tasks for async import processing

## Important Invariants / Constraints

- Import hierarchy: `ImportRecord` → `ImportBatch` → `ImportResult`
- Status transitions are one-way (CREATED → STARTED → COMPLETED/FAILED)
- Deadlocks can occur during high-concurrency imports; service retries automatically
- Each `ImportResult` maps to one reference attempt

## Public Surface Area

### API Endpoints (see `routes.py`)

- `POST /imports` - Create new import job
- `GET /imports` - List import records
- `GET /imports/{id}` - Get import record details
- `POST /imports/{id}/batches` - Add batch to import
- `GET /imports/{id}/results` - Get import results

### Background Tasks (see `tasks.py`)

- `process_import_batch_task` - Process a single batch asynchronously

## Typical Workflows

### Creating an import

1. Create `ImportRecord` via API with metadata (source, processor type)
2. Add batches of references via `POST /imports/{id}/batches`
3. Each batch triggers background processing
4. Poll `GET /imports/{id}` for status

### Debugging failed imports

1. Check `ImportRecord.status` for overall state
2. Check `ImportBatch.status` for batch-level failures
3. Check `ImportResult` entries for per-reference errors
4. Look for `RETRYING` status indicating deadlock recovery

## Testing

```bash
# Run import domain unit tests
uv run pytest tests/unit/domain/imports/

# Run import e2e tests
uv run pytest tests/e2e/imports/
```

## Debugging Notes

- Batch stuck in STARTED? Check background task queue and logs
- Deadlock errors? Usually resolve on retry; check for hot rows if persistent
- Partial failures? Check `ImportResult` entries with FAILED status

## Related Docs

- `docs/claude/imports.md` - Detailed import internals
- `../references/.doc.md` - Reference creation (called by imports)
- `docs/procedures/batch-importing.rst` - User guide for imports
- `docs/repo-map.md` - Repository overview

## Folder Structure

```text
imports/
├── models/
│   ├── models.py      # Domain models (ImportRecord, ImportBatch, ImportResult)
│   ├── sql.py         # SQLAlchemy ORM models
│   └── projections.py # Computed/derived models
├── services/
│   └── anti_corruption_service.py  # SDK <-> domain translation
├── repository.py  # Repository pattern implementation
├── routes.py      # FastAPI routes
├── service.py     # Main domain service
└── tasks.py       # Background tasks
```
