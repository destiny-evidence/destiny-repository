services:
  db:
    volumes:
      - /var/lib/postgresql/data
  fs:
    volumes:
      - /data
  fs-seed:
    image: minio/mc
    depends_on:
      fs:
        condition: service_healthy
    volumes:
      - .minio:/.minio
    environment:
      MINIO_URL: "http://fs:9000"
      MINIO_ROOT_USER: localuser
      MINIO_ROOT_PASSWORD: localpass
      MINIO_SEED_DATA_DIR: .minio/data
      MINIO_PRESIGNED_URL_FILEPATH: .minio/presigned_urls.json
    entrypoint: ./.minio/seed_fileserver.sh
  db-seed:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_URL: "postgresql+asyncpg://localuser:localpass@db:5432/destiny_dev"
      ENV: "dev"
      AZURE_APPLICATION_ID: "dummy"
      AZURE_TENANT_ID: "dummy"
    entrypoint: alembic upgrade head
  repository:
    build:
      context: .
      dockerfile: Dockerfile
    image: destiny-repository
    depends_on:
      db-seed:
        condition: service_completed_successfully
      fs-seed:
        condition: service_completed_successfully
      http:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./app:/src/app
    env_file:
      - .env
    environment:
      # Overwrite with docker network hostname
      MESSAGE_BROKER_URL: amqp://guest:guest@rabbitmq:5672
      DB_URL: "postgresql+asyncpg://localuser:localpass@db:5432/destiny_dev"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; sock = socket.create_connection(('localhost',8000), 2); sock.close()",
        ]
      interval: 2s
      timeout: 2s
      retries: 5

  e2e-task-worker:
    build:
      context: .
      args:
        POETRY_INSTALL_DEV: "true"
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./app:/app/app
    env_file:
      - .env
    environment:
      - MESSAGE_BROKER_URL=amqp://guest:guest@rabbitmq:5672
      - DB_URL=postgresql+asyncpg://localuser:localpass@db:5432/destiny_dev
    entrypoint: taskiq worker app.tasks:broker --fs-discover --reload

  e2e:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    volumes:
      - ./tests/e2e:/e2e
      - ./.minio/presigned_urls.json:/.minio/presigned_urls.json
    ports:
      - 8001:8001
    depends_on:
      repository:
        condition: service_healthy
      e2e-task-worker:
        condition: service_started
    environment:
      DB_URL: "postgresql+psycopg://localuser:localpass@db:5432/destiny_dev"
      REPO_URL: "http://repository:8000"
      HTTP_CLIENT_URL: "http://http:5678"
      MINIO_URL: "http://fs:9000"
      CALLBACK_URL: "http://e2e:8001"
      ENV: "dev"
      MINIO_PRESIGNED_URL_FILEPATH: /.minio/presigned_urls.json
    entrypoint: /venv/bin/pytest /e2e

# Use fresh volumes for tests
volumes: {}
